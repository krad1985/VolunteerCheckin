<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>義工報到系統 v2.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    [v-cloak] { display: none; }
    .card-active { border-left: 5px solid #10b981; }
    .card-inactive { border-left: 5px solid #ef4444; }
    .card-ignore { border-left: 5px solid #cbd5e1; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="app" v-cloak class="max-w-md mx-auto min-h-screen flex flex-col">
    
    <!-- Loading -->
    <div v-if="loading" class="fixed inset-0 z-50 bg-white/90 flex flex-col items-center justify-center">
      <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent animate-spin rounded-full mb-4"></div>
      <div class="font-bold text-gray-600">{{ loadingText }}</div>
    </div>

    <!-- Header -->
    <header class="bg-blue-800 text-white p-4 shadow-lg sticky top-0 z-40">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="font-bold text-lg">義工報到回報系統</h1>
          <p class="text-[10px] opacity-70">UID 模式 | 一次報到未來生效</p>
        </div>
        <input type="date" v-model="reportDate" @change="loadMembers" class="bg-blue-700 text-xs p-1 rounded border-none outline-none">
      </div>
    </header>

    <main class="p-4 space-y-4 pb-24">
      <!-- Step 1: 選組 -->
      <div v-if="step === 1" class="bg-white p-6 rounded-2xl shadow-sm border space-y-4">
        <h2 class="text-xl font-bold">選擇回報範圍</h2>
        <div>
          <label class="text-xs text-gray-400">大組</label>
          <select v-model="selectedBig" class="w-full p-3 bg-gray-50 border rounded-xl mt-1">
            <option v-for="g in groups" :key="g.name" :value="g.name">{{ g.name }}</option>
          </select>
        </div>
        <div v-if="selectedBig">
          <label class="text-xs text-gray-400">小組</label>
          <select v-model="selectedSmall" class="w-full p-3 bg-gray-50 border rounded-xl mt-1">
            <option v-for="s in currentSubGroups" :key="s" :value="s">{{ s }}</option>
          </select>
        </div>
        <button @click="loadMembers" :disabled="!selectedSmall" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold disabled:opacity-30">進入名單</button>
      </div>

      <!-- Step 2: 名單 -->
      <div v-if="step === 2" class="space-y-3">
        <div class="flex justify-between items-end px-1">
          <button @click="step = 1" class="text-blue-600 text-sm font-bold flex items-center">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"></path></svg> 返回
          </button>
          <div class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold">
            實到 {{ stats.arrived }} / 應到 {{ stats.expected }}
          </div>
        </div>

        <div v-for="m in members" :key="m.uid" 
             class="bg-white p-4 rounded-xl shadow-sm border flex justify-between items-center"
             :class="m.isArrived ? 'card-active' : (m.isExpected ? 'card-inactive' : 'card-ignore')">
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <span class="font-bold text-lg">{{ m.name }}</span>
              <button @click="openEdit(m)" class="text-gray-300 hover:text-blue-500">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
              </button>
            </div>
            <div class="text-[10px] text-gray-400">UID: {{ m.uid }} | {{ m.phone || '無電話' }}</div>
            <div class="flex gap-2 mt-1">
              <span v-if="m.details.lunch === '是'" class="bg-orange-100 text-orange-600 text-[9px] px-1 rounded">午</span>
              <span v-if="m.details.dinner === '是'" class="bg-purple-100 text-purple-600 text-[9px] px-1 rounded">晚</span>
              <span v-if="m.details.stay === '是'" class="bg-indigo-100 text-indigo-600 text-[9px] px-1 rounded">住</span>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <button v-if="!m.isArrived" @click="toggleCheckIn(m, true)" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm">報到</button>
            <button v-else @click="toggleCheckIn(m, false)" class="bg-white border-2 border-green-600 text-green-600 px-3 py-2 rounded-lg text-sm font-bold">已在場 (取消)</button>
          </div>
        </div>

        <button @click="showTempModal = true" class="w-full border-2 border-dashed border-gray-300 text-gray-500 py-4 rounded-xl font-bold text-sm bg-white">＋ 臨時義工報到</button>
      </div>
    </main>

    <!-- Edit Modal -->
    <div v-if="editingMember" class="fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-6">
      <div class="bg-white w-full rounded-3xl p-6 space-y-4">
        <h3 class="font-bold text-xl border-b pb-2">{{ editingMember.name }} - 詳情修改</h3>
        <div class="grid grid-cols-3 gap-3">
          <div v-for="key in ['lunch', 'dinner', 'stay']" :key="key" class="text-center">
            <label class="text-xs text-gray-400 block mb-1">{{ key==='lunch'?'午餐':key==='dinner'?'晚餐':'住宿' }}</label>
            <select v-model="editingMember.details[key]" class="w-full p-2 bg-gray-50 border rounded-lg text-sm">
              <option value="是">是</option>
              <option value="否">否</option>
              <option value="無">無</option>
            </select>
          </div>
        </div>
        <div class="flex gap-2 pt-4">
          <button @click="editingMember = null" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold">取消</button>
          <button @click="saveEdit" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold">儲存並刷新</button>
        </div>
      </div>
    </div>

    <!-- Temp Modal -->
    <div v-if="showTempModal" class="fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-6">
      <div class="bg-white w-full rounded-3xl p-6 space-y-4">
        <h3 class="font-bold text-xl">臨時報名</h3>
        <input v-model="tempForm.name" placeholder="姓名" class="w-full p-3 bg-gray-50 border rounded-xl">
        <input v-model="tempForm.phone" placeholder="電話" class="w-full p-3 bg-gray-50 border rounded-xl">
        <div class="flex gap-2">
          <button @click="showTempModal = false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold">取消</button>
          <button @click="handleTemp" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold">報到</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbx5RwtQbE1kRran4GDXTh2M5ZLojNhzL-mAP32OO_Aa5-6ek4gHPYERFqjmVjJa9LH7/exec";
    const LIFF_ID = "2008940815-C8JZBiJj";

    const { createApp } = Vue;
    createApp({
      data() {
        return {
          loading: true, loadingText: '連線中...', step: 1,
          groups: [], selectedBig: '', selectedSmall: '',
          members: [], reportDate: new Date().toISOString().split('T')[0],
          editingMember: null, showTempModal: false,
          tempForm: { name: '', phone: '', gender: '未知' },
          userId: '', userName: ''
        }
      },
      computed: {
        currentSubGroups() {
          const g = this.groups.find(x => x.name === this.selectedBig);
          return g ? g.subGroups : [];
        },
        stats() {
          return {
            expected: this.members.filter(m => m.isExpected).length,
            arrived: this.members.filter(m => m.isArrived).length
          }
        }
      },
      async mounted() {
        try {
          await liff.init({ liffId: LIFF_ID });
          if (!liff.isLoggedIn()) { liff.login(); return; }
          const p = await liff.getProfile();
          this.userId = p.userId; this.userName = p.displayName;
          const res = await this.api('getInitialData');
          this.groups = res.groups;
          this.loading = false;
        } catch (e) { alert("ERROR: " + e.message); }
      },
      methods: {
        async api(action, payload = {}) {
          const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action, payload }) });
          return await res.json();
        },
        async loadMembers() {
          this.loading = true;
          this.loadingText = "抓取名單...";
          const res = await this.api('getVolunteerList', {
            bigGroup: this.selectedBig, smallGroup: this.selectedSmall, targetDate: this.reportDate
          });
          this.members = res.list;
          this.step = 2;
          this.loading = false;
        },
        async toggleCheckIn(m, status) {
          this.loading = true;
          if (status) {
            await this.api('submitCheckIn', { uid: m.uid, name: m.name, date: this.reportDate, operator: this.userName });
          } else {
            if(!confirm("確定要取消此人的報到紀錄嗎？")) { this.loading = false; return; }
            await this.api('cancelCheckIn', { uid: m.uid, date: this.reportDate });
          }
          await this.loadMembers();
        },
        openEdit(m) { this.editingMember = JSON.parse(JSON.stringify(m)); },
        async saveEdit() {
          this.loading = true;
          await this.api('updateVolunteer', {
            rowNum: this.editingMember.rowNum,
            colIdx: this.editingMember.colIdx,
            values: this.editingMember.details
          });
          this.editingMember = null;
          await this.loadMembers();
        },
        async handleTemp() {
          if(!this.tempForm.name) return;
          this.loading = true;
          await this.api('registerTemp', { ...this.tempForm, bigGroup: this.selectedBig, smallGroup: this.selectedSmall });
          this.showTempModal = false;
          await this.loadMembers();
        }
      }
    }).mount('#app');
  </script>
</body>
</html>