<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾©å·¥å ±åèˆ‡é»åç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .loading-overlay {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
        }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

<div id="app" class="max-w-md mx-auto p-4 pb-24">
    <!-- é ‚éƒ¨æ¨™é¡Œèˆ‡ç‹€æ…‹ -->
    <header class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">ç¾©å·¥ç®¡ç†ç³»çµ±</h1>
            <p id="cacheStatus" class="text-xs text-slate-400">è³‡æ–™å·²å¾é›²ç«¯åŒæ­¥</p>
        </div>
        <button onclick="refreshData(true)" class="p-2 bg-white rounded-full shadow-sm hover:bg-blue-50 text-blue-600 transition-colors">
            <i class="fa-solid fa-arrows-rotate"></i>
        </button>
    </header>

    <!-- çµ±è¨ˆèˆ‡æœå°‹ä¸­å¿ƒ -->
    <div class="bg-white rounded-2xl p-4 shadow-sm mb-6 border border-slate-100">
        <div class="flex items-center gap-2 mb-3">
            <i class="fa-solid fa-magnifying-glass text-slate-400"></i>
            <input type="text" id="searchInput" oninput="handleSearch()" placeholder="è¼¸å…¥é—œéµå­—æœå°‹æˆ–çµ±è¨ˆ..." 
                   class="w-full outline-none text-slate-700 bg-transparent">
        </div>
        <div id="statsPreview" class="hidden mt-2 p-3 bg-blue-50 rounded-xl text-sm text-blue-800 border border-blue-100">
            <!-- çµ±è¨ˆçµæœæœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>
    </div>

    <!-- åå–®åˆ—è¡¨ -->
    <div id="volunteerList" class="space-y-3">
        <!-- ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
        <div class="py-10 text-center text-slate-400">
            <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
            <p>æ­£åœ¨è¼‰å…¥åå–®...</p>
        </div>
    </div>
</div>

<!-- ç·¨è¼¯æ¨¡æ…‹è¦–çª— -->
<div id="editModal" class="fixed inset-0 z-50 hidden flex items-end sm:items-center justify-center p-4 loading-overlay">
    <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl shadow-2xl p-6 fade-in border-t border-slate-100">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-slate-800" id="modalName">ä¿®æ”¹è³‡æ–™</h3>
            <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>
        
        <div id="editFields" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
            <!-- å‹•æ…‹ç”Ÿæˆ I åˆ° M æ¬„çš„ç·¨è¼¯é … -->
            <p class="text-sm text-slate-500 italic">æ­£åœ¨è®€å–éå¾€ç´€éŒ„...</p>
        </div>

        <div class="mt-6 flex gap-3">
            <button onclick="closeModal()" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold">å–æ¶ˆ</button>
            <button id="saveBtn" onclick="saveEdit()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-200">æ›´æ–°ç´€éŒ„</button>
        </div>
    </div>
</div>

<!-- åå¸é€šçŸ¥ -->
<div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 px-6 py-3 bg-slate-800 text-white text-sm rounded-full opacity-0 transition-opacity pointer-events-none z-50">
    å·²æ›´æ–°
</div>

<script>
    // é…ç½®å€åŸŸ - è«‹ç¢ºä¿èˆ‡ Google Apps Script ç«¯ä¸€è‡´
    const CONFIG = {
        GAS_URL = 'https://script.google.com/macros/s/AKfycbx5RwtQbE1kRran4GDXTh2M5ZLojNhzL-mAP32OO_Aa5-6ek4gHPYERFqjmVjJa9LH7/exec',
		LIFF_ID = '2008940815-C8JZBiJj',
        cacheTimeKey: 'v_data_timestamp',
        cacheTTL: 1000 * 60 * 30, // 30 åˆ†é˜å¿«å–
        columns: ['I', 'J', 'K', 'L', 'M'],
        colLabels: ['å ±åç‹€æ…‹', 'åˆé¤éœ€æ±‚', 'äº¤é€šæ–¹å¼', 'åˆ†çµ„ä»»å‹™', 'å‚™è¨»äº‹é …']
    };

    let volunteers = [];
    let currentEditRow = null;

    // åˆå§‹åŒ–
    window.onload = () => {
        loadData();
    };

    // 1. å¿«å–åŠŸèƒ½å¯¦ä½œ
    async function loadData() {
        const cachedData = localStorage.getItem(CONFIG.cacheKey);
        const lastSync = localStorage.getItem(CONFIG.cacheTimeKey);
        const now = new Date().getTime();

        if (cachedData && lastSync && (now - lastSync < CONFIG.cacheTTL)) {
            volunteers = JSON.parse(cachedData);
            document.getElementById('cacheStatus').innerText = 'æ¨¡å¼ï¼šå¿«é€Ÿè®€å– (å¿«å–ä¸­)';
            renderList(volunteers);
        } else {
            refreshData();
        }
    }

    async function refreshData(force = false) {
        document.getElementById('cacheStatus').innerText = 'æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...';
        try {
            // æ³¨æ„ï¼šé€™è£¡å‡è¨­å¾Œç«¯æœƒå›å‚³æ•´å¼µè¡¨çš„ JSON
            const response = await fetch(`${CONFIG.scriptUrl}?action=getVolunteers`);
            const result = await response.json();
            
            volunteers = result.data;
            localStorage.setItem(CONFIG.cacheKey, JSON.stringify(volunteers));
            localStorage.setItem(CONFIG.cacheTimeKey, new Date().getTime().toString());
            
            document.getElementById('cacheStatus').innerText = 'è³‡æ–™å·²åŒæ­¥';
            renderList(volunteers);
        } catch (e) {
            showToast('åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
            if (!force) loadFromCacheOnly();
        }
    }

    function renderList(data) {
        const container = document.getElementById('volunteerList');
        container.innerHTML = data.map((person, index) => `
            <div class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-50">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold">
                        ${person.name[0]}
                    </div>
                    <div>
                        <div class="font-bold text-slate-800">${person.name}</div>
                        <div class="text-xs text-slate-400">${person.department || 'ä¸€èˆ¬çµ„'}</div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="openEditModal(${index})" class="p-2 text-slate-400 hover:text-blue-500 transition-colors">
                        <i class="fa-solid fa-pen-to-square text-lg"></i>
                    </button>
                    <button onclick="toggleAttendance(${index})" id="check-${index}" 
                            class="p-2 ${person.present ? 'text-green-500' : 'text-slate-200'} transition-colors">
                        <i class="fa-solid fa-circle-check text-2xl"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    // 2. ç·¨è¼¯åŠŸèƒ½æ“´å¼µ (I-M æ¬„)
    function openEditModal(index) {
        const person = volunteers[index];
        currentEditRow = index;
        document.getElementById('modalName').innerText = `${person.name} - è©³ç´°è³‡æ–™`;
        
        const fieldsContainer = document.getElementById('editFields');
        // å‡è¨­ person ç‰©ä»¶åŒ…å« columnsI åˆ° columnsM çš„å±¬æ€§
        // åœ¨ Google Sheet ä¸­ï¼ŒI æ˜¯ index 8
        fieldsContainer.innerHTML = CONFIG.colLabels.map((label, i) => {
            const colKey = `col_${CONFIG.columns[i]}`; // å°æ‡‰å¾Œç«¯å›å‚³çš„ key
            const val = person[colKey] || '';
            return `
                <div>
                    <label class="block text-xs font-semibold text-slate-500 mb-1">${label} (æ¬„ä½ ${CONFIG.columns[i]})</label>
                    <input type="text" id="input-${CONFIG.columns[i]}" value="${val}" 
                           class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-400 transition-all text-slate-700">
                </div>
            `;
        }).join('');

        document.getElementById('editModal').classList.remove('hidden');
    }

    async function saveEdit() {
        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        btn.innerText = 'å„²å­˜ä¸­...';

        const updates = {};
        CONFIG.columns.forEach(col => {
            updates[col] = document.getElementById(`input-${col}`).value;
        });

        try {
            // ç™¼é€åˆ° GAS æ›´æ–°æŒ‡å®šè¡Œæ•¸
            const response = await fetch(CONFIG.scriptUrl, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'updateDetails',
                    row: volunteers[currentEditRow].rowNumber,
                    updates: updates
                })
            });
            
            // æ›´æ–°æœ¬åœ°å¿«å–
            CONFIG.columns.forEach((col, i) => {
                volunteers[currentEditRow][`col_${col}`] = updates[col];
            });
            localStorage.setItem(CONFIG.cacheKey, JSON.stringify(volunteers));
            
            showToast('æ›´æ–°æˆåŠŸ');
            closeModal();
            renderList(volunteers);
        } catch (e) {
            showToast('å„²å­˜å¤±æ•—');
        } finally {
            btn.disabled = false;
            btn.innerText = 'æ›´æ–°ç´€éŒ„';
        }
    }

    function closeModal() {
        document.getElementById('editModal').classList.add('hidden');
    }

    // 3. çµ±è¨ˆåŠŸèƒ½èˆ‡ Flex Message é‚è¼¯
    function handleSearch() {
        const query = document.getElementById('searchInput').value.trim();
        const preview = document.getElementById('statsPreview');
        
        if (!query) {
            preview.classList.add('hidden');
            renderList(volunteers);
            return;
        }

        // éæ¿¾åˆ—è¡¨
        const filtered = volunteers.filter(p => p.name.includes(query) || (p.col_I && p.col_I.includes(query)));
        renderList(filtered);

        // å¦‚æœè¼¸å…¥çš„æ˜¯ã€Œçµ±è¨ˆã€é—œéµå­—
        if (query === 'çµ±è¨ˆ' || query === 'status') {
            const total = volunteers.length;
            const present = volunteers.filter(p => p.present).length;
            const lunch = volunteers.filter(p => p.col_J === 'æ˜¯' || p.col_J === 'ç´ é£Ÿ').length;

            preview.innerHTML = `
                <div class="flex flex-col gap-1">
                    <div class="font-bold mb-1">ğŸ“Š æœ¬æ—¥æ´»å‹•çµ±è¨ˆæ‘˜è¦</div>
                    <div class="flex justify-between"><span>ç¸½å ±åäººæ•¸:</span> <b>${total} äºº</b></div>
                    <div class="flex justify-between"><span>å·²åˆ°å ´äººæ•¸:</span> <b>${present} äºº</b></div>
                    <div class="flex justify-between"><span>ç”¨é¤äººæ•¸:</span> <b>${lunch} äºº</b></div>
                    <button onclick="copyFlexMessage()" class="mt-2 py-1 bg-white rounded-lg text-xs font-bold border border-blue-200">è¤‡è£½ LINE Flex è¨Šæ¯</button>
                </div>
            `;
            preview.classList.remove('hidden');
        } else {
            preview.classList.add('hidden');
        }
    }

    // ç”Ÿæˆä¸¦è¤‡è£½ Flex Message JSON (ç”¨æ–¼ LINE æ©Ÿå™¨äºº)
    function copyFlexMessage() {
        const total = volunteers.length;
        const present = volunteers.filter(p => p.present).length;
        
        const flex = {
            "type": "bubble",
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    { "type": "text", "text": "ç¾©å·¥æ´»å‹•å ±åçµ±è¨ˆ", "weight": "bold", "size": "xl" },
                    { "type": "separator", "margin": "md" },
                    { "type": "box", "layout": "vertical", "margin": "lg", "spacing": "sm", "contents": [
                        { "type": "box", "layout": "baseline", "spacing": "sm", "contents": [
                            { "type": "text", "text": "ç¸½äººæ•¸", "color": "#aaaaaa", "size": "sm", "flex": 1 },
                            { "type": "text", "text": `${total} äºº`, "wrap": true, "color": "#666666", "size": "sm", "flex": 5 }
                        ]},
                        { "type": "box", "layout": "baseline", "spacing": "sm", "contents": [
                            { "type": "text", "text": "å·²åˆ°å ´", "color": "#aaaaaa", "size": "sm", "flex": 1 },
                            { "type": "text", "text": `${present} äºº`, "wrap": true, "color": "#666666", "size": "sm", "flex": 5 }
                        ]}
                    ]}
                ]
            }
        };

        const textArea = document.createElement("textarea");
        textArea.value = JSON.stringify(flex);
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast('Flex Message å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.opacity = '1';
        setTimeout(() => t.style.opacity = '0', 2000);
    }

    function toggleAttendance(index) {
        volunteers[index].present = !volunteers[index].present;
        localStorage.setItem(CONFIG.cacheKey, JSON.stringify(volunteers));
        renderList(volunteers);
        showToast(volunteers[index].present ? 'å·²å®Œæˆé»å' : 'å·²å–æ¶ˆé»å');
        
        // é€™è£¡å¯ä»¥å‘¼å« GAS æ›´æ–°åˆ° Google Sheets çš„ B æ¬„(å‡è¨­æ˜¯å‡ºå¸­æ¬„)
    }

</script>
</body>
</html>